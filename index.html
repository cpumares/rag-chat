<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Chat con criterios DGSFP</title>

<style>
  /* ——— Layout general ——— */
  body{
    font-family:sans-serif;
    max-width:900px;          /* ① MÁS ANCHO (antes 600 px) */
    margin:auto;
    padding:1rem;
  }
  #chat{
    border:1px solid #ccc;
    padding:.5rem;
    height:60vh;
    overflow-y:auto;
  }

  /* ——— Mensajes ——— */
  .msg{margin:.4rem 0}
  .user{color:#006cbb;font-weight:600}
  .bot {color:#222}

  /* ——— Enlaces dentro del chat ——— */
  #chat a{
    color:#0077cc;
    text-decoration:underline;
  }
  #chat a:hover{text-decoration:none}

  /* ——— Cuadro de entrada ——— */
  #prompt{                       /* ② usa id="prompt" */
    width:100%;                 /* ocupa todo el contenedor */
    padding:.6rem;
    font-size:1rem;
    box-sizing:border-box;
    margin:0;
  }
</style>
</head>
<body>

<h2>Asistente RAG DGSFP</h2>

<div id="chat"></div>

<form id="form">
  <input id="prompt" placeholder="Escribe tu pregunta sobre criterios DGSFP"
         autocomplete="off" />
</form>

<script>
/* ------------------- Datos de tu webhook ------------------- */
const webhook = "https://antoniosautomationcentral.duckdns.org/webhook/ceb907d0-9012-4c5c-9b3d-90ee88761ba5";

/* ------------------- Accesos al DOM ------------------------ */
const chat = document.getElementById("chat");
const txt  = document.getElementById("txt");

/* ------------------- Utilidades ---------------------------- */
/* 1) Limpia URLs que a veces vienen con “)” u otros signos al final */
function sanitizeUrl(u){
  return u.replace(/[)\]\s]+$/,''); // quita ) ] espacios finales
}

/* 2) Añade un mensaje al chat */
function add(text, cls){
  const div = document.createElement("div");
  div.className = "msg "+cls;

  /* Sustituimos URLs por enlaces clicables que NO navegan */
  div.innerHTML = text.replace(
    /(https?:\/\/\S+)/g,
    raw => {
      const url = sanitizeUrl(raw);
      return `<a href="#" data-url="${url}">${url}</a>`;
    }
  );
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* ------------------- Envío de preguntas -------------------- */
document.getElementById("form").addEventListener("submit", async e=>{
  e.preventDefault();
  const q = txt.value.trim();
  if(!q) return;
  add(q, "user");
  txt.value = "";

  try{
    const res  = await fetch(webhook, {
      method: "POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ question: q })
    });
    const data = await res.json();      // { answer:"..." }
    add(data.answer || "[sin respuesta]", "bot");
  }catch(err){
    add("Error: "+err, "bot");
  }
});

/* ----------------- Decodificador de PDF -------------------- */
/* Escucha clics en enlaces insertados por el bot */
chat.addEventListener("click", async ev=>{
  const a = ev.target.closest('a[data-url]');
  if(!a) return;                   // no es nuestro enlace
  ev.preventDefault();

  const apiUrl = a.dataset.url;    // …/obtenerDatosDocumento?d=123
  try{
    const res  = await fetch(apiUrl);
    const json = await res.json(); // <-- devuelve base-64

    /* Ajusta aquí el nombre real del campo que contiene la base-64 */
    const b64  = json.contenidoDocumento || json.file || json.data;
    if(!b64) throw "No se encontró el PDF en la respuesta";

    /* base-64  →  bytes */
    const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const blob  = new Blob([bytes], { type:"application/pdf" });
    const url   = URL.createObjectURL(blob);

    window.open(url,"_blank");
  }catch(err){
    add("Error al abrir el PDF: "+err,"bot");
  }
});
</script>
</body>
</html>
